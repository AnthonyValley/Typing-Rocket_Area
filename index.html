<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Rocket DSA - Area</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;700&display=swap');
        :root { --bg-color: #0f172a; --accent-color: #38bdf8; --danger-color: #f472b6; --text-color: #f1f5f9; --panel-bg: rgba(30, 41, 59, 0.95); --gold: #fbbf24; }
        body { margin: 0; overflow: hidden; background-color: var(--bg-color); color: var(--text-color); font-family: 'Lexend', Verdana, sans-serif; user-select: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); z-index: 10; }
        #login-screen { display: flex; }
        h1 { font-size: 3rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; text-shadow: 0 0 15px var(--accent-color); text-align: center; }
        input, select { padding: 12px 20px; font-size: 1rem; border-radius: 8px; border: 2px solid var(--accent-color); background: rgba(15, 23, 42, 0.8); color: white; outline: none; width: 250px; text-align: center; margin-top: 5px; display: block; }
        button { margin-top: 15px; padding: 12px 30px; font-size: 1.2rem; background-color: var(--accent-color); color: #0f172a; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); }
        .secondary-btn { background-color: transparent; border: 2px solid var(--accent-color); color: var(--accent-color); }
        #game-interface { display: none; width: 100%; height: 100vh; position: relative; }
        #hud-top { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 5; font-size: 1.5rem; font-weight: bold; }
        #input-display { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 2rem; padding: 10px 40px; border-radius: 12px; background: var(--panel-bg); border: 2px solid var(--accent-color); min-width: 200px; text-align: center; }
        .rocket { position: absolute; padding: 8px 15px; background: rgba(255, 255, 255, 0.1); border: 2px solid var(--danger-color); border-radius: 8px; font-size: 1.3rem; font-weight: bold; color: white; box-shadow: 0 0 10px var(--danger-color); }
        #pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        #history-list { list-style: none; padding: 0; width: 90%; max-width: 500px; max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; }
        #history-list li { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1>Typing Rocket üöÄ</h1>
        <p>Area Studenti DSA</p>
        <div class="form-group">
            <input type="text" id="username" placeholder="Nome Utente">
            <input type="password" id="password" placeholder="Password">
        </div>
        <button onclick="doLogin()">ENTRA / REGISTRATI</button>
        <p id="login-msg" style="font-size: 0.8rem; color: #fbbf24; margin-top:10px;"></p>
    </div>

    <div id="menu-screen" class="screen">
        <h1>Ciao <span id="display-user" style="color:var(--accent-color)"></span></h1>
        <div class="form-group">
            <select id="difficulty-select">
                <option value="elementari">Elementari</option>
                <option value="medie">Medie</option>
                <option value="superiori">Superiori</option>
            </select>
        </div>
        <button onclick="startGame()">GIOCA ORA</button>
        <br><button class="secondary-btn" onclick="showHistory()">CLASSIFICA üèÜ</button>
        <br><button class="secondary-btn" onclick="logout()" style="font-size:0.9rem; margin-top:20px; border-color:#64748b; color:#64748b">ESCI</button>
    </div>

    <div id="history-screen" class="screen">
        <h2>Top 10 Punteggi</h2>
        <ul id="history-list">Caricamento...</ul>
        <button class="secondary-btn" onclick="backToMenu()">INDIETRO</button>
    </div>

    <div id="game-interface">
        <div id="hud-top">
            <div>Liv: <span id="level-label">...</span></div>
            <div>Punti: <span id="score">0</span></div>
            <button id="pause-btn" onclick="togglePause()" style="font-size:1rem; padding: 5px 15px; margin:0;">PAUSA</button>
        </div>
        <div id="input-display">...</div>
        <div id="pause-overlay">
            <h2 style="color:white;">PAUSA</h2>
            <button onclick="togglePause()">RIPRENDI</button>
            <button class="secondary-btn" onclick="quitGame()">ESCI</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ukmwguhqvjfomwbevdaa.supabase.co'; 
        
        const SUPABASE_KEY = 'sb_publishable_b2dcoNBg8e9MNltpvTVgZg_uUyHqlYY'; 

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const dbParole = {
            elementari: ["CASA", "SOLE", "MELA", "GATTO", "MARE", "LUCE", "PANE", "LUNA", "PERA", "FIORE"],
            medie: ["SCUOLA", "ALBERO", "FUTURO", "VIAGGIO", "AMICIZIA", "MUSICA", "TEMPO", "SPAZIO"],
            superiori: ["ALGORITMO", "DATABASE", "PYTHON", "VARIABILE", "FUNZIONE", "SINTASSI", "NETWORK", "SERVER"]
        };
        let currentUser = null;
        let gameState = { active: false, paused: false, score: 0, level: 'elementari', rockets: [], spawnRate: 2000, fallSpeed: 1, currentInput: "", spawnTimer: null };

        async function doLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const msg = document.getElementById('login-msg');
            if(!u || !p) return alert("Inserisci nome e password");
            msg.innerText = "Connessione al database...";
            let { data: users, error } = await supabase.from('utenti').select('*').eq('username', u);
            if (error) { alert("Errore connessione. Hai incollato il link giusto? " + error.message); return; }
            if (users.length > 0) {
                if (users[0].password === p) proceedToMenu(u);
                else { msg.innerText = ""; alert("Password errata!"); }
            } else {
                const { error: insertError } = await supabase.from('utenti').insert([{ username: u, password: p }]);
                if(!insertError) { alert("Nuovo account creato! Benvenuto " + u); proceedToMenu(u); }
                else alert("Errore creazione account.");
            }
        }
        function proceedToMenu(u) { currentUser = u; document.getElementById('display-user').innerText = u; document.getElementById('login-msg').innerText = ""; showScreen('menu-screen'); }
        async function saveScore() { if(!currentUser) return; await supabase.from('partite').insert([{ username: currentUser, score: gameState.score, livello: gameState.level }]); }
        async function showHistory() {
            showScreen('history-screen'); const list = document.getElementById('history-list'); list.innerHTML = "Caricamento dal cloud...";
            let { data: scores, error } = await supabase.from('partite').select('*').order('score', { ascending: false }).limit(10);
            list.innerHTML = "";
            if (!scores || scores.length === 0) list.innerHTML = "<li>Nessun record trovato.</li>";
            else scores.forEach(row => { const li = document.createElement('li'); li.innerHTML = `<span><b>${row.username}</b> (${row.livello})</span> <span style="color:#fbbf24">${row.score} pts</span>`; list.appendChild(li); });
        }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.style.display = 'none'); document.getElementById('game-interface').style.display = 'none'; document.getElementById(id).style.display = 'flex'; }
        function logout() { currentUser = null; document.getElementById('username').value=""; document.getElementById('password').value=""; showScreen('login-screen'); }
        function backToMenu() { showScreen('menu-screen'); }
        function startGame() {
            gameState.level = document.getElementById('difficulty-select').value;
            if(gameState.level === 'elementari') { gameState.fallSpeed = 0.8; gameState.spawnRate = 2500; }
            if(gameState.level === 'medie') { gameState.fallSpeed = 1.5; gameState.spawnRate = 2000; }
            if(gameState.level === 'superiori') { gameState.fallSpeed = 2.5; gameState.spawnRate = 1500; }
            showScreen('game-interface'); document.getElementById('game-interface').style.display = 'block'; document.getElementById('level-label').innerText = gameState.level.toUpperCase(); document.getElementById('pause-overlay').style.display = 'none';
            gameState.active = true; gameState.paused = false; gameState.score = 0; gameState.rockets = []; gameState.currentInput = "";
            document.querySelectorAll('.rocket').forEach(el => el.remove()); updateScoreUI(); loop(); scheduleSpawn();
        }
        function togglePause() { gameState.paused = !gameState.paused; document.getElementById('pause-overlay').style.display = gameState.paused ? 'flex' : 'none'; if(!gameState.paused) { loop(); scheduleSpawn(); } else { clearTimeout(gameState.spawnTimer); } }
        function quitGame() { gameState.active = false; saveScore(); backToMenu(); }
        function scheduleSpawn() { if(!gameState.active || gameState.paused) return; gameState.spawnTimer = setTimeout(() => { spawnRocket(); scheduleSpawn(); }, gameState.spawnRate); }
        function spawnRocket() {
            if(gameState.paused) return; const words = dbParole[gameState.level]; const text = words[Math.floor(Math.random() * words.length)];
            const div = document.createElement('div'); div.className = 'rocket'; div.innerText = text; div.style.left = Math.floor(Math.random() * (window.innerWidth - 200) + 50) + "px"; div.style.top = "-60px";
            document.getElementById('game-interface').appendChild(div); gameState.rockets.push({ element: div, text: text, y: -60 });
        }
        function loop() {
            if(!gameState.active || gameState.paused) return;
            gameState.rockets.forEach((r, i) => { r.y += gameState.fallSpeed; r.element.style.top = r.y + "px"; if(r.y > window.innerHeight - 50) gameOver(); });
            if(gameState.active) requestAnimationFrame(loop);
        }
        document.addEventListener('keydown', (e) => {
            if(!gameState.active || gameState.paused) return;
            if(e.key === 'Backspace') gameState.currentInput = gameState.currentInput.slice(0, -1); else if(e.key.length === 1) gameState.currentInput += e.key.toUpperCase();
            const disp = document.getElementById('input-display'); disp.innerText = gameState.currentInput;
            const matchIdx = gameState.rockets.findIndex(r => r.text === gameState.currentInput);
            if(matchIdx !== -1) { gameState.rockets[matchIdx].element.remove(); gameState.rockets.splice(matchIdx, 1); gameState.score += 10; gameState.currentInput = ""; disp.innerText = ""; disp.style.borderColor = "#4ade80"; setTimeout(()=>disp.style.borderColor="#38bdf8",200); updateScoreUI(); }
        });
        function updateScoreUI() { document.getElementById('score').innerText = gameState.score; }
        function gameOver() { gameState.active = false; alert("GAME OVER! Punti: " + gameState.score); saveScore(); backToMenu(); }
    </script>
</body>
</html>
